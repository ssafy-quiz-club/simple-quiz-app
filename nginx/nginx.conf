# 80 → 443 리다이렉션
server {
    listen 80;
    server_name quiz-api.kro.kr;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name quiz-api.kro.kr;

    # --- SSL ---
    ssl_certificate     /etc/nginx/ssl/fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/quiz-api.kro.kr.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # ---- 공통 프록시 헤더 ----
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;

    # =========================
    # 1) API: https://quiz-api.kro.kr/api/** → backend:8080
    # =========================
    location /api/ {
        # 백엔드가 이미 /api/** 경로로 서비스한다면,
        # URI를 수정하지 않도록 upstream에 "경로 없이" 넘기는 게 안전함.
        proxy_pass http://backend:8080;

        # (선택) 업스트림 리다이렉트 보정
        proxy_redirect off;

        # (선택) 타임아웃/바디 크기
        proxy_read_timeout 60s;
        client_max_body_size 10m;

        # ✅ 동일 출처이므로 CORS 헤더는 굳이 추가하지 않습니다.
        # add_header Access-Control-Allow-Origin ...  ← 필요 없음
    }

    # =========================
    # 2) 프론트: https://quiz-api.kro.kr/** → GitHub Pages 프록시
    #    실제 GH Pages 경로: https://ssafy-quiz-club.github.io/simple-quiz-app/
    # =========================
    location / {
        # location / 에서 요청 URI를 "/simple-quiz-app/"에 붙여서 전달
        proxy_pass https://ssafy-quiz-club.github.io/simple-quiz-app/;

        # GH Pages는 SNI/호스트명 기준이므로 반드시 설정
        proxy_set_header Host ssafy-quiz-club.github.io;
        proxy_ssl_server_name on;

        # (선택) 정적 캐시 힌트
        proxy_read_timeout 30s;
    }
}
