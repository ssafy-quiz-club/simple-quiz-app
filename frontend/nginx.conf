# /etc/nginx/conf.d/default.conf

# 80 -> 443
server {
    listen 80;
    server_name quiz-api.kro.kr;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name quiz-api.kro.kr;

    # --- SSL ---
    ssl_certificate     /etc/nginx/ssl/fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/quiz-api.kro.kr.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # --- 외부 도메인 프록시용 DNS 리졸버 (IPv6 비활성화) ---
    resolver 1.1.1.1 8.8.8.8 valid=300s ipv6=off;

    # ========= API: 동일 도메인 → 백엔드 (우선 매칭) =========
    location ^~ /api/ {
        proxy_pass http://backend:8080;
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_redirect off;
        proxy_read_timeout 60s;
        client_max_body_size 10m;
    }

    # ========= 루트: 프론트 index.html만 프록시 (주소 유지) =========
    location = / {
        proxy_pass https://ssafy-quiz-club.github.io/simple-quiz-app/;
        proxy_set_header Host ssafy-quiz-club.github.io;
        proxy_ssl_server_name on;

        # GH Pages가 절대 URL로 리다이렉트해도 내 도메인 경로로 재작성
        proxy_redirect https://ssafy-quiz-club.github.io/simple-quiz-app/ /;
        proxy_redirect https://ssafy-quiz-club.github.io/ /;

        # HTML은 항상 최신
        proxy_ignore_headers Expires Cache-Control;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # ========= 나머지 모든 경로: prefix 없을 때만 붙여 프록시 =========
    location / {
        # 이미 /simple-quiz-app/ 로 시작하면 건드리지 않음(이중 prefix 방지)
        rewrite ^/(?!simple-quiz-app/)(.*)$ /simple-quiz-app/$1 break;

        proxy_pass https://ssafy-quiz-club.github.io;
        proxy_set_header Host ssafy-quiz-club.github.io;
        proxy_ssl_server_name on;

        # upstream 절대 리다이렉트 → 내 도메인 경로로 재작성
        proxy_redirect https://ssafy-quiz-club.github.io/simple-quiz-app/ /;
        proxy_redirect https://ssafy-quiz-club.github.io/ /;

        # 정적 자산 캐싱(원하면 활성화)
        # add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # ❌ if 블록엔 proxy_set_header 넣지 않기
    # ❌ CORS에 add_header * 넣지 않기(충돌 원인)
}
